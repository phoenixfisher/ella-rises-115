<!DOCTYPE html>
<html lang="en">
<head>
    <%- include("partials/header") %>
</head>

<body>
    <!-- Navbar -->
    <nav>
        <!-- Brand logo -->
        <a class="brand" href="/">
            <img src="/images/ella_logo.png" alt="Ella Rises" class="brand-logo">
            <span>Ella Rises</span>
        </a>
        
        <!-- Navbar links -->
        <% if (!user) { %>
            <%- include("partials/navbar_visitor") %>
        <% } else if (user.level === "M") { %>
            <%- include("partials/navbar_admin") %>
        <% } else { %>
            <%- include("partials/navbar_user") %>
        <% } %>
    </nav>

    <main class="content">

        <!-- Flash messages -->
        <% if (messages && Object.keys(messages).length > 0) { %>
            <div class="flash-container" aria-live="polite">
                <% Object.keys(messages).forEach(type => {
                    const list = Array.isArray(messages[type]) ? messages[type] : [messages[type]];
                %>
                    <% list.forEach(msg => { if (msg) { %>
                        <div class="flash <%= type %>">
                            <span class="flash-content"><%= msg %></span>
                            <button type="button" class="flash-close" aria-label="Close message">Ã—</button>
                        </div>
                    <% } }) %>
                <% }) %>
            </div>
        <% } %>

        <!-- Page content -->
        <%- body %>
    </main>

    <%- include("partials/footer") %>

    <script>
        (function() {
            // Highlight current nav link
            const links = document.querySelectorAll('.nav-links a[href]');
            const normalize = (value) => {
                const cleaned = (value || '').replace(/\/+$/, '').replace(/^\/+/, '').toLowerCase();
                return cleaned || '/';
            };
            const baseKey = (value) => {
                const norm = (value || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                if (!norm) return '';
                if (norm.endsWith('es')) return norm.slice(0, -2);
                if (norm.endsWith('s')) return norm.slice(0, -1);
                return norm;
            };

            const path = (window.location.pathname.replace(/\/+$/, '') || '/');
            const pathNorm = normalize(path);
            const pathLast = pathNorm === '/' ? '' : pathNorm.split('/').filter(Boolean).pop();
            const pathBase = baseKey(pathLast);
            const pathKeys = pathNorm === '/'
                ? []
                : pathNorm.split('/').filter(Boolean).map(baseKey).filter(Boolean);

            links.forEach(link => {
                const target = (link.getAttribute('href') || '').replace(/\/+$/, '') || '/';
                const targetNorm = normalize(target);
                const targetLast = targetNorm === '/' ? '' : targetNorm.split('/').filter(Boolean).pop();
                const targetBase = baseKey(targetLast);

                const isExact = target === path;
                const isParent = target !== '/' && path.startsWith(target + '/');
                const isLooseMatch = target !== '/' &&
                    targetBase &&
                    pathBase &&
                    Math.min(targetBase.length, pathBase.length) >= 4 &&
                    (pathBase.includes(targetBase) || targetBase.includes(pathBase));
                const isSegmentMatch = target !== '/' &&
                    targetBase &&
                    targetBase.length >= 3 &&
                    pathKeys.some(key => Math.min(key.length, targetBase.length) >= 3 &&
                        (key.includes(targetBase) || targetBase.includes(key)));

                if (isExact || isParent || isLooseMatch || isSegmentMatch) {
                    link.classList.add('active');
                }
            });

            const flashes = document.querySelectorAll('.flash');
            flashes.forEach(flash => {
                const closer = flash.querySelector('.flash-close');
                if (closer) {
                    closer.addEventListener('click', () => {
                        flash.classList.add('fade');
                        setTimeout(() => flash.remove(), 200);
                    });
                }
                setTimeout(() => {
                    flash.classList.add('fade');
                    setTimeout(() => flash.remove(), 200);
                }, 5000);
            });
        })();
    </script>
</body>
</html>
